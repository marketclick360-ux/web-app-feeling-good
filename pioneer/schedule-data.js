// Weekly Meeting Schedule Data
// Auto-generated from jw.org
// All meeting content links back to jw.org for compliance.

const MEETING_SCHEDULE = [
  {
    startDate: "2026-01-05",
    endDate: "2026-01-11",
    weekLabel: "January 5-11, 2026",
    theme: "Jehovah\u2019s Purpose Will Be Fulfilled",
    scripture: "\u201CJehovah of armies has sworn: \u2018Just as I have intended, so it will be, and just as I have decided, that is what will come true.\u2019\u201D \u2014 Isaiah 14:24",
    treasuresTalk: "Jehovah\u2019s Purpose Cannot Be Thwarted",
    bibleReading: "Isa. 14:1-11 (th study 5)",
    watchtowerArticle: "Maintain Your Joy in Old Age",
    watchtowerUrl: "https://www.jw.org/en/library/magazines/watchtower-study-november-2025/Maintain-Your-Joy-in-Old-Age/",
    workbookUrl: "https://www.jw.org/en/library/jw-meeting-workbook/january-february-2026-mwb/Life-and-Ministry-Meeting-Schedule-for-January-5-11-2026/",
    keyScriptures: [
      { ref: "Ps. 92:12-14", book: "psalms", chapter: 92 },
      { ref: "Isa. 40:29-31", book: "isaiah", chapter: 40 },
      { ref: "Ps. 37:25", book: "psalms", chapter: 37 },
      { ref: "Job 33:25", book: "job", chapter: 33 },
      { ref: "Isa. 33:24", book: "isaiah", chapter: 33 },
      { ref: "Phil. 4:6, 7", book: "philippians", chapter: 4 }
    ]
  },
  {
    startDate: "2026-01-12",
    endDate: "2026-01-18",
    weekLabel: "January 12-18, 2026",
    theme: "Stay Watchful and Alert",
    scripture: "\u201CWatchman, what about the night? Watchman, what about the night?\u201D \u2014 Isaiah 21:11",
    treasuresTalk: "Be a Watchman in These Last Days",
    bibleReading: "Isa. 21:1-12 (th study 10)",
    watchtowerArticle: "Maintain Your Joy as a Caregiver",
    watchtowerUrl: "https://www.jw.org/en/library/magazines/watchtower-study-november-2025/Maintain-Your-Joy-as-a-Caregiver/",
    workbookUrl: "https://www.jw.org/en/library/jw-meeting-workbook/january-february-2026-mwb/Life-and-Ministry-Meeting-Schedule-for-January-12-18-2026/",
    keyScriptures: [
      { ref: "Gal. 6:2", book: "galatians", chapter: 6 },
      { ref: "Isa. 40:29", book: "isaiah", chapter: 40 },
      { ref: "1 Pet. 5:7", book: "1-peter", chapter: 5 },
      { ref: "Prov. 17:22", book: "proverbs", chapter: 17 },
      { ref: "Job 1:21, 22", book: "job", chapter: 1 },
      { ref: "Job 2:9, 10", book: "job", chapter: 2 },
      { ref: "Jas. 5:11", book: "james", chapter: 5 },
      { ref: "Rom. 8:28", book: "romans", chapter: 8 },
      { ref: "Ps. 34:18, 19", book: "psalms", chapter: 34 }
    ]
  },
  {
    startDate: "2026-01-19",
    endDate: "2026-01-25",
    weekLabel: "January 19-25, 2026",
    theme: "Look! This Is Our God!",
    scripture: "\u201CIn that day one will say: \u2018Look! This is our God! We have hoped in him, and he will save us.\u2019\u201D \u2014 Isaiah 25:9",
    treasuresTalk: "\u201CThis Is Our God!\u201D",
    bibleReading: "Isa. 25:1\u201326:6 (th study 2)",
    watchtowerArticle: "Consider Our Sympathetic High Priest\u2014Jesus",
    watchtowerUrl: "https://www.jw.org/en/library/magazines/watchtower-study-november-2025/Consider-Our-Sympathetic-High-Priest-Jesus/",
    workbookUrl: "https://www.jw.org/en/library/jw-meeting-workbook/january-february-2026-mwb/Life-and-Ministry-Meeting-Schedule-for-January-19-25-2026/",
    keyScriptures: [
      { ref: "Heb. 4:15, 16", book: "hebrews", chapter: 4 },
      { ref: "Heb. 2:17, 18", book: "hebrews", chapter: 2 },
      { ref: "Isa. 53:4, 5", book: "isaiah", chapter: 53 },
      { ref: "1 John 2:1, 2", book: "1-john", chapter: 2 },
      { ref: "Matt. 11:28-30", book: "matthew", chapter: 11 }
    ]
  },
  {
    startDate: "2026-01-26",
    endDate: "2026-02-01",
    weekLabel: "January 26\u2013February 1, 2026",
    theme: "Jehovah Will Help His People",
    scripture: "\u201CTrust in Jehovah forever, for Jah Jehovah is the eternal Rock.\u201D \u2014 Isaiah 26:4",
    treasuresTalk: "Honor Jehovah With Your Lips and Your Heart",
    bibleReading: "Isa. 29:1-14 (th study 5)",
    watchtowerArticle: "\u201CYou Are Someone Very Precious!\u201D",
    watchtowerUrl: "https://www.jw.org/en/library/magazines/watchtower-study-november-2025/You-Are-Someone-Very-Precious/",
    workbookUrl: "https://www.jw.org/en/library/jw-meeting-workbook/january-february-2026-mwb/Life-and-Ministry-Meeting-Schedule-for-January-26-February-1-2026/",
    keyScriptures: [
      { ref: "Ps. 139:1-4", book: "psalms", chapter: 139 },
      { ref: "Isa. 43:4", book: "isaiah", chapter: 43 },
      { ref: "Matt. 10:29-31", book: "matthew", chapter: 10 },
      { ref: "Jer. 31:3", book: "jeremiah", chapter: 31 },
      { ref: "1 John 3:19, 20", book: "1-john", chapter: 3 }
    ]
  },
  {
    startDate: "2026-02-02",
    endDate: "2026-02-08",
    weekLabel: "February 2-8, 2026",
    theme: "The Result of True Righteousness Will Be Peace",
    scripture: "\u201CThe result of true righteousness will be peace, and the fruitage of true righteousness will be lasting tranquility and security.\u201D \u2014 Isaiah 32:17",
    treasuresTalk: "Find Refuge Under Jehovah\u2019s Wings",
    bibleReading: "Isa. 32:1\u201333:6 (th study 12)",
    watchtowerArticle: "The Book of Job Can Help You When You Suffer",
    watchtowerUrl: "https://www.jw.org/en/library/magazines/watchtower-study-december-2025/The-Book-of-Job-Can-Help-You-When-You-Suffer/",
    workbookUrl: "https://www.jw.org/en/library/jw-meeting-workbook/january-february-2026-mwb/Life-and-Ministry-Meeting-Schedule-for-February-2-8-2026/",
    keyScriptures: [
      { ref: "Job 1:21, 22", book: "job", chapter: 1 },
      { ref: "Job 2:9, 10", book: "job", chapter: 2 },
      { ref: "Jas. 5:11", book: "james", chapter: 5 },
      { ref: "Rom. 8:28", book: "romans", chapter: 8 },
      { ref: "Ps. 34:18, 19", book: "psalms", chapter: 34 }
    ]
  },
  {
    startDate: "2026-02-09",
    endDate: "2026-02-15",
    weekLabel: "February 9-15, 2026",
    theme: "He Is the Stability of Your Times",
    scripture: "\u201CHe is the stability of your times, an abundance of salvation, wisdom, and knowledge.\u201D \u2014 Isaiah 33:6",
    treasuresTalk: "He Is the Stability of Your Times",
    bibleReading: "Isa. 35:1-10 (th study 12)",
    watchtowerArticle: "The Book of Job Can Help You When You Give Counsel",
    watchtowerUrl: "https://www.jw.org/en/library/magazines/watchtower-study-december-2025/The-Book-of-Job-Can-Help-You-When-You-Give-Counsel/",
    workbookUrl: "https://www.jw.org/en/library/jw-meeting-workbook/january-february-2026-mwb/Life-and-Ministry-Meeting-Schedule-for-February-9-15-2026/",
    keyScriptures: [
      { ref: "Job 4:7, 8", book: "job", chapter: 4 },
      { ref: "Job 8:5, 6", book: "job", chapter: 8 },
      { ref: "Job 42:7, 8", book: "job", chapter: 42 },
      { ref: "Prov. 12:18", book: "proverbs", chapter: 12 },
      { ref: "Col. 4:6", book: "colossians", chapter: 4 }
    ]
  },
  {
    startDate: "2026-02-16",
    endDate: "2026-02-22",
    weekLabel: "February 16-22, 2026",
    theme: "Jehovah Will Defend His People",
    scripture: "\u201CI will defend this city and save it for my own sake and for the sake of my servant David.\u201D \u2014 Isaiah 37:35",
    treasuresTalk: "Jehovah Will Defend His People",
    bibleReading: "Isa. 36:1\u201337:7 (th study 10)",
    watchtowerArticle: "Imitate Jehovah\u2019s Humility",
    watchtowerUrl: "https://www.jw.org/en/library/magazines/watchtower-study-december-2025/Imitate-Jehovahs-Humility/",
    workbookUrl: "https://www.jw.org/en/library/jw-meeting-workbook/january-february-2026-mwb/Life-and-Ministry-Meeting-Schedule-for-February-16-22-2026/",
    keyScriptures: [
      { ref: "Phil. 2:3, 4", book: "philippians", chapter: 2 },
      { ref: "Mic. 6:8", book: "micah", chapter: 6 },
      { ref: "Isa. 57:15", book: "isaiah", chapter: 57 },
      { ref: "Ps. 138:6", book: "psalms", chapter: 138 }
    ]
  },
  {
    startDate: "2026-02-23",
    endDate: "2026-03-01",
    weekLabel: "February 23\u2013March 1, 2026",
    theme: "Those Hoping in Jehovah Will Regain Power",
    scripture: "\u201CThose hoping in Jehovah will regain power.\u201D \u2014 Isaiah 40:31",
    treasuresTalk: "Those Hoping in Jehovah Will Regain Power",
    bibleReading: "Isa. 40:1-17 (th study 2)",
    watchtowerArticle: "How to Plan a Wedding That Brings Honor to Jehovah",
    watchtowerUrl: "https://www.jw.org/en/library/magazines/watchtower-study-december-2025/How-to-Plan-a-Wedding-That-Brings-Honor-to-Jehovah/",
    workbookUrl: "https://www.jw.org/en/library/jw-meeting-workbook/january-february-2026-mwb/Life-and-Ministry-Meeting-Schedule-for-February-23-March-1-2026/",
    keyScriptures: [
      { ref: "Phil. 4:5", book: "philippians", chapter: 4 },
      { ref: "Heb. 13:4", book: "hebrews", chapter: 13 },
      { ref: "1 Cor. 7:39", book: "1-corinthians", chapter: 7 },
      { ref: "Prov. 19:2", book: "proverbs", chapter: 19 }
    ]
  }
];

// ============================================================
// DAILY TEXT â€” auto-fetches today's text from jw.org
// URL pattern: https://wol.jw.org/en/wol/dt/r1/lp-e/YYYY/M/D
// We link directly to jw.org so user reads it there (compliant)
// ============================================================
function loadDailyText() {
  var el = document.getElementById("dailyText");
  if (!el) return;

  var today = new Date();
  var yyyy = today.getFullYear();
  var mm = today.getMonth() + 1;
  var dd = today.getDate();

  var dailyTextUrl = "https://wol.jw.org/en/wol/dt/r1/lp-e/" + yyyy + "/" + mm + "/" + dd;
  var jwDailyTextUrl = "https://www.jw.org/en/library/brochures/Examining-the-Scriptures-Daily-2026/";

  var dayNames = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
  var monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
  var dateLabel = dayNames[today.getDay()] + ", " + monthNames[today.getMonth()] + " " + dd + ", " + yyyy;

  el.innerHTML =
    '<span class="daily-text-label">\uD83D\uDCD6 DAILY TEXT \u2014 ' + dateLabel + '</span>' +
    '<a href="' + dailyTextUrl + '" target="_blank" rel="noopener noreferrer" ' +
    'style="color:var(--color-secondary);text-decoration:underline;font-weight:600;">' +
    'Tap here to read today\u2019s Daily Text on jw.org \u2192</a>' +
    '<span class="daily-text-ref">' +
    '<a href="' + jwDailyTextUrl + '" target="_blank" rel="noopener noreferrer" ' +
    'style="color:var(--color-secondary);text-decoration:none;font-size:0.8rem;">' +
    'Examining the Scriptures Daily\u20142026</a></span>';
}

// ============================================================
// SAVED NOTES â€” per week, localStorage
// ============================================================
var STORAGE_KEY_PREFIX = "pioneer_notes_";

function getSavedNotes(weekLabel) {
  try {
    var raw = localStorage.getItem(STORAGE_KEY_PREFIX + weekLabel);
    return raw ? JSON.parse(raw) : null;
  } catch (e) { return null; }
}

function saveWeekNotes(weekLabel, data) {
  try {
    localStorage.setItem(STORAGE_KEY_PREFIX + weekLabel, JSON.stringify(data));
  } catch (e) { console.warn("Could not save notes:", e); }
}

function collectNotes() {
  var notes = {};
  document.querySelectorAll("[data-note-id]").forEach(function(el) {
    notes[el.getAttribute("data-note-id")] = el.value || "";
  });
  document.querySelectorAll("[data-check-id]").forEach(function(el) {
    notes[el.getAttribute("data-check-id")] = el.checked;
  });
  return notes;
}

function restoreNotes(weekLabel) {
  var saved = getSavedNotes(weekLabel);
  if (!saved) return;
  Object.keys(saved).forEach(function(key) {
    var el = document.querySelector('[data-note-id="' + key + '"]');
    if (el) { el.value = saved[key]; return; }
    var cb = document.querySelector('[data-check-id="' + key + '"]');
    if (cb) cb.checked = !!saved[key];
  });
}

function enableAutoSave(weekLabel) {
  document.querySelectorAll("[data-note-id]").forEach(function(el) {
    el.addEventListener("input", function() {
      saveWeekNotes(weekLabel, collectNotes());
    });
  });
  document.querySelectorAll("[data-check-id]").forEach(function(el) {
    el.addEventListener("change", function() {
      saveWeekNotes(weekLabel, collectNotes());
    });
  });
}

// ============================================================
// WEEK NAVIGATION & SCHEDULE RENDERING
// ============================================================
var currentWeekIndex = null;

function parseLocalDate(dateStr) {
  var parts = dateStr.split("-").map(Number);
  return new Date(parts[0], parts[1] - 1, parts[2], 0, 0, 0, 0);
}

function getCurrentWeekSchedule() {
  var today = new Date();
  today.setHours(0, 0, 0, 0);

  if (currentWeekIndex !== null && MEETING_SCHEDULE[currentWeekIndex]) {
    return MEETING_SCHEDULE[currentWeekIndex];
  }

  for (var i = 0; i < MEETING_SCHEDULE.length; i++) {
    var week = MEETING_SCHEDULE[i];
    var start = parseLocalDate(week.startDate);
    var end = parseLocalDate(week.endDate);
    end.setHours(23, 59, 59, 999);
    if (today >= start && today <= end) {
      currentWeekIndex = i;
      return week;
    }
  }

  var lastWeek = MEETING_SCHEDULE[MEETING_SCHEDULE.length - 1];
  var lastEnd = parseLocalDate(lastWeek.endDate);
  if (today > lastEnd) {
    currentWeekIndex = MEETING_SCHEDULE.length - 1;
    return MEETING_SCHEDULE[currentWeekIndex];
  }

  currentWeekIndex = 0;
  return MEETING_SCHEDULE[0];
}

function navigateWeek(direction) {
  var currentSchedule = getCurrentWeekSchedule();
  saveWeekNotes(currentSchedule.weekLabel, collectNotes());

  if (currentWeekIndex === null) getCurrentWeekSchedule();
  var newIndex = currentWeekIndex + direction;
  if (newIndex >= 0 && newIndex < MEETING_SCHEDULE.length) {
    currentWeekIndex = newIndex;
    renderCurrentSchedule();
  }
}

function jwLink(url, text) {
  return '<a href="' + url + '" target="_blank" rel="noopener noreferrer">' + text + '</a>';
}

function scriptureUrl(book, chapter) {
  return "https://www.jw.org/en/library/bible/study-bible/books/" + book + "/" + chapter + "/";
}

function renderCurrentSchedule() {
  var schedule = getCurrentWeekSchedule();
  var wbUrl = schedule.workbookUrl;
  var wtUrl = schedule.watchtowerUrl;

  // === HEADER ===
  var weekInfo = document.querySelector(".week-info");
  if (weekInfo) {
    weekInfo.innerHTML = jwLink(wbUrl, "\uD83D\uDCC5 Week of " + schedule.weekLabel);
  }

  var themeElement = document.querySelector(".meeting-theme");
  if (themeElement) {
    themeElement.innerHTML =
      "Midweek Theme: " +
      jwLink(wbUrl, '<strong>\u201C' + schedule.theme + '\u201D</strong>');
  }

  // === WEEK NAVIGATION ===
  var navButtons = document.querySelector(".week-navigation");
  if (!navButtons) {
    navButtons = document.createElement("div");
    navButtons.className = "week-navigation";
    navButtons.style.cssText = "display:flex;gap:10px;justify-content:center;margin:12px 0;";

    var prevBtn = document.createElement("button");
    prevBtn.textContent = "\u2190 Previous Week";
    prevBtn.style.cssText = "padding:8px 16px;background:#5B9BD5;color:white;border:none;border-radius:6px;cursor:pointer;font-size:0.9rem;";
    prevBtn.onclick = function() { navigateWeek(-1); };

    var nextBtn = document.createElement("button");
    nextBtn.textContent = "Next Week \u2192";
    nextBtn.style.cssText = "padding:8px 16px;background:#5B9BD5;color:white;border:none;border-radius:6px;cursor:pointer;font-size:0.9rem;";
    nextBtn.onclick = function() { navigateWeek(1); };

    navButtons.appendChild(prevBtn);
    navButtons.appendChild(nextBtn);

    if (weekInfo && weekInfo.parentNode) {
      weekInfo.parentNode.insertBefore(navButtons, weekInfo.nextSibling);
    }
  }

  var prevB = navButtons.querySelector("button:first-child");
  var nextB = navButtons.querySelector("button:last-child");
  if (prevB) { prevB.disabled = (currentWeekIndex === 0); prevB.style.opacity = currentWeekIndex === 0 ? "0.4" : "1"; }
  if (nextB) { nextB.disabled = (currentWeekIndex === MEETING_SCHEDULE.length - 1); nextB.style.opacity = currentWeekIndex === MEETING_SCHEDULE.length - 1 ? "0.4" : "1"; }

  // === MEETING PREP TAB ===
  var meetingDiv = document.getElementById("meeting");
  if (meetingDiv) {
    // H2 title
    var meetingH2 = meetingDiv.querySelector("h2");
    if (meetingH2) {
      meetingH2.innerHTML = "\uD83D\uDCDD " + jwLink(wbUrl, "Meeting Preparation \u2014 Week of " + schedule.weekLabel);
    }

    // First .meeting-content: Main Theme + Bible Reading
    var allMeetingContent = meetingDiv.querySelectorAll(".meeting-content");
    if (allMeetingContent.length >= 1) {
      var firstBlock = allMeetingContent[0];
      var paras = firstBlock.querySelectorAll("p");
      // First <p> = Main Theme
      if (paras.length >= 1) {
        paras[0].innerHTML =
          "<strong>Main Theme:</strong> " +
          jwLink(wbUrl, '\u201C' + schedule.treasuresTalk + '\u201D / \u201C' + schedule.theme + '\u201D');
      }
      // Second <p> = Bible Reading
      if (paras.length >= 2) {
        paras[1].innerHTML =
          "<strong>Bible Reading:</strong> " +
          jwLink(wbUrl, schedule.bibleReading);
      }
    }

    // H3 links
    var h3s = meetingDiv.querySelectorAll("h3");
    h3s.forEach(function(h3) {
      var txt = h3.textContent;
      if (txt.indexOf("Midweek") !== -1 || txt.indexOf("Life") !== -1) {
        h3.innerHTML = jwLink(wbUrl, "Midweek Meeting (Life & Ministry)");
      }
      if (txt.indexOf("Treasures From") !== -1) {
        h3.innerHTML = jwLink(wbUrl, "Treasures From God\u2019s Word (10 min)");
      }
      if (txt.indexOf("Spiritual Gems") !== -1) {
        h3.innerHTML = jwLink(wbUrl, "Spiritual Gems (10 min)");
      }
      if (txt.indexOf("Apply Yourself") !== -1) {
        h3.innerHTML = jwLink(wbUrl, "Apply Yourself to the Field Ministry");
      }
      if (txt.indexOf("Congregation Bible Study") !== -1) {
        h3.innerHTML = jwLink(wbUrl, "Congregation Bible Study (30 min)");
      }
      if (txt.indexOf("Weekend Meeting") !== -1) {
        h3.innerHTML = jwLink(wtUrl, "Weekend Meeting (Public Talk & Watchtower Study)");
      }
    });

    // Watchtower article title
    var wtArticleEl = meetingDiv.querySelector(".wt-article-title");
    if (wtArticleEl && schedule.watchtowerArticle) {
      wtArticleEl.innerHTML = jwLink(wtUrl, schedule.watchtowerArticle);
    }

    // Reference link under WT article
    var refLink = meetingDiv.querySelector(".reference-link");
    if (refLink) {
      refLink.innerHTML = jwLink(wtUrl, "Read this week\u2019s Watchtower study article on jw.org \u2192");
    }

    // Key Scriptures
    var keyScripturesEl = meetingDiv.querySelector(".key-scriptures-list");
    if (keyScripturesEl && schedule.keyScriptures && schedule.keyScriptures.length > 0) {
      var html = '<strong>Key Scriptures:</strong><ul style="margin-top:8px;padding-left:18px;">';
      schedule.keyScriptures.forEach(function(s) {
        var url = scriptureUrl(s.book, s.chapter);
        html += '<li style="margin-bottom:4px;">' + jwLink(url, s.ref) + '</li>';
      });
      html += '</ul>';
      keyScripturesEl.innerHTML = html;
    }
  }

  // === RESTORE NOTES FOR THIS WEEK ===
  restoreNotes(schedule.weekLabel);
  enableAutoSave(schedule.weekLabel);

  console.log("Schedule loaded for:", schedule.weekLabel);
}

// ============================================================
// PRINT STYLES â€” injected once
// ============================================================
(function() {
  var s = document.createElement("style");
  s.textContent =
    "@media print {" +
    "  .week-navigation, nav, footer, #save-status-bar { display: none !important; }" +
    "  details { display: block !important; }" +
    "  textarea { border: 1px solid #ccc !important; min-height: 60px; white-space: pre-wrap; overflow: visible !important; height: auto !important; }" +
    "  .meeting-content, .card, #meeting { break-inside: avoid; }" +
    "  body { font-size: 12pt; padding-bottom: 0 !important; }" +
    "  a { color: #333 !important; text-decoration: underline; }" +
    '  a::after { content: " (" attr(href) ")"; font-size: 7pt; color: #666; word-break: break-all; }' +
    "  .tab-content { display: block !important; }" +
    "  .tabs { display: none !important; }" +
    "}";
  document.head.appendChild(s);
})();

// ============================================================
// INITIALIZE ON PAGE LOAD
// ============================================================
document.addEventListener("DOMContentLoaded", function() {
  currentWeekIndex = null;
  renderCurrentSchedule();
  loadDailyText();
});
